<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Classifier Data - Image Recognition Primer</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="expanded "><a href="../training-data/index.html"><strong aria-hidden="true">2.</strong> Training Data Generation</a></li><li><ol class="section"><li class="expanded "><a href="../training-data/basic-image-manipulation.html"><strong aria-hidden="true">2.1.</strong> Full Image Generation</a></li><li class="expanded "><a href="../training-data/classifier-generation.html" class="active"><strong aria-hidden="true">2.2.</strong> Classifier Data</a></li><li class="expanded "><a href="../training-data/detector-generation.html"><strong aria-hidden="true">2.3.</strong> Detector Data</a></li></ol></li><li class="expanded "><a href="../convolution-neural-networks/index.html"><strong aria-hidden="true">3.</strong> Neural Networks</a></li><li><ol class="section"><li class="expanded "><a href="../convolution-neural-networks/inter-to-neural-nets.html"><strong aria-hidden="true">3.1.</strong> Intro to Neural Nets</a></li><li class="expanded "><a href="../convolution-neural-networks/convolutional-neural-networks.html"><strong aria-hidden="true">3.2.</strong> Convolutional Neural Networks</a></li></ol></li><li class="expanded "><a href="../yolo-architecture/index.html"><strong aria-hidden="true">4.</strong> YOLO Object Detector</a></li><li><ol class="section"><li class="expanded "><a href="../yolo-architecture/yolo-architecture.html"><strong aria-hidden="true">4.1.</strong> YOLO Architecture</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Image Recognition Primer</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#classifier-data" id="classifier-data">Classifier Data</a></h1>
<p>So now we have our background image with an artificial target on it. We need to generate the data to train our classifier. Darknet needs the training images to be labeled as follows: <code>//path//to//image//index_classid.ext</code>. For our purposes we have two classification classes, target (index = 0) and background (index = 1).</p>
<p>Passing a 4200x2200 image through our model would take way too long to process. Either we could downsample the image to a size more digestible for a model, like 800x800, or we can slice up the larger image into smaller tiles. We will do the latter because downsampling the entire image would make the targets way too small. </p>
<p>Let's slice up our larger image into our two different classification categories, target and background. If the slice contains the target, then we want that image to be separated as a target-containing image and the others background.</p>
<p>We need to define some constansts that we will use to create the training data:</p>
<pre><code class="language-python"># Program imports
import os
import random
from PIL import Image

# Define crop sizes
CROP_WIDTH = 416
CROP_HEIGHT = 416

# Size of the classification data
CLF_WIDTH = 416
CLF_HEIGHT = 416

# Amount of overlap between image slices
OVERLAP = 50

# Set the two classification types
CLASSES = ['background', 'shape_target']
</code></pre>
<p>First, let's make a function to check wether or not a target is inside the image slice or not. This function needs to take in the tile dimensions and target information from the txt we previously generatd.</p>
<pre><code class="language-python">def contains_shape(x1, y1, x2, y2, data):

    for shape_desc, bx, by, bw, bh in data:

        if x1 &lt; bx &lt; bx + bw &lt; x2 and y1 &lt; by &lt; by + bh &lt; y2:
            return True

    return False
</code></pre>
<p>Second, we need a function to slice up the image and also call the <code> contains_shape</code> function we made.</p>
<pre><code class="language-python">def create_clf_data(dataset_name, dataset_path, image_name, image, data):
    &quot;&quot;&quot;Generate data for the classifier model&quot;&quot;&quot;
    full_width, full_height = image.size
    # Empty list to store background and shape crops
    backgrounds = []
    shapes = []
    # Cycle through ccrops
    for y1 in range(0, full_height - CROP_HEIGHT, CROP_HEIGHT - OVERLAP):

        for x1 in range(0, full_width - CROP_WIDTH, CROP_WIDTH - OVERLAP):

            y2 = y1 + CROP_HEIGHT
            x2 = x1 + CROP_WIDTH
            # Crop
            cropped_img = image.crop((x1, y1, x2, y2))
            # Resize for classification size
            cropped_img = cropped_img.resize((CLF_WIDTH, CLF_HEIGHT))
            # Check if shape inside crop
            if contains_shape(x1, y1, x2, y2, data):
                shapes.append(cropped_img) 
            else:
                backgrounds.append(cropped_img)
                
    # Keep classes balanced and randomize data
    num_data = min(len(backgrounds), len(shapes))
    random.shuffle(backgrounds)
    random.shuffle(shapes)
    # Path where we will write path to image crops
    list_fn = os.path.join(dataset_path,
                            '{}_list.txt'.format(dataset_name))

    for i in range(num_data):
	# Name for image with target
        shape_fn = '{}_{}_{}.png'.format(CLASSES[1], image_name, i)
	# Path for image with target
        shape_path = os.path.join(os.getcwd(), dataset_path, shape_fn)
	# Name for background image
        bg_fn = '{}_{}_{}.png'.format(CLASSES[0], image_name, i)
	# Full path for background image
        bg_path = os.path.join(os.getcwd(), dataset_path, bg_fn)
	# Save the images
        shapes[i].save(shape_path)
        backgrounds[i].save(bg_path)
	# Write the paths to the images. Need this for model training
        with open(list_fn, 'a') as list_file:
            list_file.write(shape_path + &quot;\n&quot;)
            list_file.write(bg_path + &quot;\n&quot;)
</code></pre>
<p>Third, let's make a function to do a couple things:</p>
<ul>
<li>Create folders to save our image slices</li>
<li>Collect the target information in the image from the txt</li>
<li>Pass all aforementioned information into our <code>create_clf_data</code> function</li>
</ul>
<pre><code class="language-python">def convert_data(img_path):
    # Get paths to new images and image dir
    new_dataset = os.path.join(os.getcwd(),'imgs')
    new_images_path = os.path.join(os.getcwd(), new_dataset, 'clf_imgs')
    # Make new directory
    os.makedirs(new_images_path, exist_ok=True)
    # Get txt for image
    label_fn = img_path.replace('.jpg', '.txt')
    # Initialize list to hold shape parameters
    image_data = []
    # Read in target information for this image
    with open(label_fn, 'r') as label_file:
        for line in label_file.readlines():
            shape_desc, x, y, w, h = line.strip().split(' ')
            x, y, w, h = int(x), int(y), int(w), int(h)
            image_data.append((shape_desc, x, y, w, h))
    
    image_name = os.path.basename(img_path).replace('.jpg', '')
    # Create the data!
    create_clf_data(new_dataset,
                    new_images_path,
                    image_name,
                    Image.open(img_path),
                    image_data)
</code></pre>
<p>These three functions constitute our classification data generation script. We can tell the python interpreter to run<code>convert_data(img)</code> by the following:</p>
<pre><code class="language-python">if __name__ == '__main__':
    convert_data('/path/to/img')
</code></pre>
<p>If we run this script, the python interpreter sets the global variable <code>__name__</code> to <code>__main__</code>, therefore we can control how the file executes with the lines above. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../training-data/basic-image-manipulation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../training-data/detector-generation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../training-data/basic-image-manipulation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../training-data/detector-generation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-105339892-2', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
